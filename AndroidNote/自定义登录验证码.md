# 自定义登录验证码

实现的效果是，登录的时候验证码数字随机出现，带有颜色的斜体。在登录输入窗口当输入字符后登录的后面会出现一键删除按钮，自定义DeletableEditText对现有EditText进行扩展，让其能一键删除

DeletableEditText.java

```java
public class DeletableEditText extends AppCompatEditText {
    private Drawable mRightDrawable;
    private boolean isHasFocus;

    public DeletableEditText(Context context) {
        this(context,null);
    }

    public DeletableEditText(Context context, AttributeSet attrs) {
        this(context, attrs,android.R.attr.editTextStyle);
    }

    public DeletableEditText(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);
        setupViews();
    }

    private void setupViews() {
        Drawable[] drawables = this.getCompoundDrawables();
        mRightDrawable = drawables[2];

        this.setOnFocusChangeListener(new FocusChangeListenerImpl());
        this.addTextChangedListener(new TextWatcherImpl());
        setClearDrawableVisible(false);
    }

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        switch (event.getAction()){
            case MotionEvent.ACTION_UP:
                boolean isClean = (event.getX() > (getWidth() - getTotalPaddingRight()))
                        && (event.getX() < (getWidth() - getPaddingRight()));
                if (isClean) {
                    setText("");
                }
                break;
            default:
                break;
        }
        return super.onTouchEvent(event);
    }
    private class FocusChangeListenerImpl implements  OnFocusChangeListener{

        @Override
        public void onFocusChange(View v, boolean hasFocus) {
            isHasFocus=hasFocus;
            if(isHasFocus){
                boolean isVisible=getText().toString().length()>=1;
                setClearDrawableVisible(isVisible);
            }else{
                setClearDrawableVisible(false);
            }
        }
    }
    private class TextWatcherImpl implements TextWatcher{

        @Override
        public void beforeTextChanged(CharSequence s, int start, int count, int after) {

        }

        @Override
        public void onTextChanged(CharSequence s, int start, int before, int count) {

        }

        @Override
        public void afterTextChanged(Editable s) {
            boolean isVisible=getText().toString().length()>=1;
            setClearDrawableVisible(isVisible);
        }
    }
    public void setClearDrawableVisible(boolean isVisible) {
        Drawable rightDrawable;
        if (isVisible) {
            rightDrawable = mRightDrawable;
        } else {
            rightDrawable = null;
        }
        setCompoundDrawables(getCompoundDrawables()[0],
                getCompoundDrawables()[1], rightDrawable,
                getCompoundDrawables()[3]);
    }

    public void setShakeAnimation(){
        this.startAnimation(ShakeAnimation(5));
    }

    private Animation ShakeAnimation(int CycleTimes) {
        Animation translateAnimation=new TranslateAnimation(0,10,0,10);
        translateAnimation.setInterpolator(new CycleInterpolator(CycleTimes));
        translateAnimation.setDuration(1000);
        return translateAnimation;
    }
}
```

activity_main.xml:

```xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
                xmlns:tools="http://schemas.android.com/tools"
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                tools:context=".MainActivity">

    <ImageView
        android:id="@+id/tv_login"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_alignParentTop="true"
        android:gravity="center"
        android:src="@mipmap/ic_launcher"
        />

    <com.mingrisoft.logindemo.DeletableEditText
        android:id="@+id/tv_user"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/tv_login"
        android:drawableLeft="@mipmap/ic_launcher"
        android:drawableRight="@mipmap/ic_launcher"
        android:ems="10"
        android:hint="请输入账户"
        android:textSize="30dp"/>

    <com.mingrisoft.logindemo.DeletableEditText
        android:id="@+id/tv_psd"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/tv_user"
        android:drawableLeft="@mipmap/ic_launcher"
        android:drawableRight="@mipmap/ic_launcher"
        android:ems="10"
        android:hint="请输入密码"
        android:inputType="textPassword"
        android:textSize="30dp"/>

    <LinearLayout
        android:id="@+id/lyYanzhengma"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/tv_psd"

        android:orientation="horizontal">

        <LinearLayout
            android:id="@+id/lyVerify"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal">

            <TextView
                android:id="@+id/tvHideA"
                android:layout_width="70dp"
                android:layout_height="70dp"
                android:gravity="center"
                android:textSize="30dp"
                android:visibility="gone"
                />

            <TextView
                android:id="@+id/tvHideB"
                android:layout_width="70dp"
                android:layout_height="70dp"
                android:gravity="center"
                android:textSize="30dp"
                android:visibility="gone"
                />

            <TextView
                android:id="@+id/tvHideC"
                android:layout_width="70dp"
                android:layout_height="70dp"
                android:gravity="center"
                android:textSize="30dp"
                android:visibility="gone"
                />

            <TextView
                android:id="@+id/tvHideD"
                android:layout_width="70dp"
                android:layout_height="70dp"
                android:gravity="center"
                android:textSize="30dp"
                android:visibility="gone"
                />
        </LinearLayout>

        <LinearLayout
            android:id="@+id/IV_num"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal">

            <ImageView
                android:id="@+id/ivNumA"
                android:layout_width="50dp"
                android:layout_height="70dp"/>

            <ImageView
                android:id="@+id/ivNumB"
                android:layout_width="50dp"
                android:layout_height="70dp"/>

            <ImageView
                android:id="@+id/ivNumC"
                android:layout_width="50dp"
                android:layout_height="70dp"/>

            <ImageView
                android:id="@+id/ivNumD"
                android:layout_width="50dp"
                android:layout_height="70dp"/>
        </LinearLayout>

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="horizontal">

            <EditText
                android:id="@+id/etCheck"
                android:layout_width="120dp"
                android:layout_height="wrap_content"
                android:hint="验证码"
                android:maxLength="4"
                android:maxLines="1"
                android:textSize="30dp"/>

            <TextView
                android:id="@+id/tvCheck"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="结果"
                android:textSize="30dp"
                android:visibility="gone"/>
        </LinearLayout>


    </LinearLayout>

    <Button
        android:id="@+id/bt_login"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/lyYanzhengma"
        android:text="登 录"
        android:textSize="30dp"/>
</RelativeLayout>
```

在Activity中引用自定义的控件，并写验证码的代码

```java
public class MainActivity extends AppCompatActivity {
    private Button btLogin;
    private DeletableEditText userEditText;
    private DeletableEditText psdEditText;
    private TextView tvHideA, tvHideB, tvHideC, tvHideD;
    private ImageView ivNumA, ivNumB, ivNumC, ivNumD;
    private EditText etCheck;
    private TextView tvCheck;

    private String numStrTmp = "";
    private String numStr = "";

    private int[] numArray = new int[4];
    private int[] colorArray = new int[6];

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        setupViews();
    }

    private void setupViews() {
        btLogin = (Button) findViewById(R.id.bt_login);
        btLogin.setOnClickListener(new OnClickListenerImpl());
        userEditText = (DeletableEditText) findViewById(R.id.tv_user);
        psdEditText = (DeletableEditText) findViewById(R.id.tv_psd);


        tvHideA = (TextView) findViewById(R.id.tvHideA);
        tvHideB = (TextView) findViewById(R.id.tvHideB);
        tvHideC = (TextView) findViewById(R.id.tvHideC);
        tvHideD = (TextView) findViewById(R.id.tvHideD);

        ivNumA = (ImageView) findViewById(R.id.ivNumA);
        ivNumB = (ImageView) findViewById(R.id.ivNumB);
        ivNumC = (ImageView) findViewById(R.id.ivNumC);
        ivNumD = (ImageView) findViewById(R.id.ivNumD);

        ivNumA.setOnClickListener(new OnClickListenerImpl());
        ivNumB.setOnClickListener(new OnClickListenerImpl());
        ivNumC.setOnClickListener(new OnClickListenerImpl());
        ivNumD.setOnClickListener(new OnClickListenerImpl());

        tvCheck = (TextView) findViewById(R.id.tvCheck);
        etCheck = (EditText) findViewById(R.id.etCheck);
        setNum();
    }

    private void setNum() {
        initNum();
        tvHideA.setText("" + numArray[0]);
        tvHideA.setTextColor(randomColor());
        tvHideB.setText("" + numArray[1]);
        tvHideB.setTextColor(randomColor());
        tvHideC.setText("" + numArray[2]);
        tvHideC.setTextColor(randomColor());
        tvHideD.setText("" + numArray[3]);
        tvHideD.setTextColor(randomColor());

        Matrix matrixA=new Matrix();
        matrixA.reset();
        matrixA.setRotate(randomAngle());
        Bitmap bmNumA=Bitmap.createBitmap(getBitmapFromView(tvHideA,20,50),0,0,20,50,matrixA,true);
        ivNumA.setImageBitmap(bmNumA);

        Matrix matrixB = new Matrix();
        //重设矩阵
        matrixB.reset();
        matrixB.setRotate(randomAngle());
        Bitmap bmNumB = Bitmap.createBitmap(getBitmapFromView(tvHideB,20,50),0,0,20,50,matrixB,true);
        ivNumB.setImageBitmap(bmNumB);

        Matrix matrixC = new Matrix();
        //重设矩阵
        matrixC.reset();
        matrixC.setRotate(randomAngle());
        Bitmap bmNumC = Bitmap.createBitmap(getBitmapFromView(tvHideC,20,50),0,0,20,50,matrixC,true);
        ivNumC.setImageBitmap(bmNumC);

        Matrix matrixD = new Matrix();
        //重设矩阵
        matrixD.reset();
        matrixD.setRotate(randomAngle());
        Bitmap bmNumD = Bitmap.createBitmap(getBitmapFromView(tvHideD,20,50),0,0,20,50,matrixD,true);
        ivNumD.setImageBitmap(bmNumD);
    }

    private Bitmap getBitmapFromView(View v, int width, int height) {
        int widSpec=View.MeasureSpec.makeMeasureSpec(width,View.MeasureSpec.EXACTLY);
        int heiSpec=View.MeasureSpec.makeMeasureSpec(height,View.MeasureSpec.EXACTLY);
        v.measure(widSpec,heiSpec);
        v.layout(0,0,width,height);
        Bitmap bitmap=Bitmap.createBitmap(width,height, Bitmap.Config.ARGB_8888);

        Canvas canvas=new Canvas(bitmap);
        v.draw(canvas);

        return bitmap;
    }

    private void initNum() {
        numStr = "";
        numStrTmp = "";
        for (int i = 0; i < numArray.length; i++) {
            int numIntImp = new Random().nextInt(10);
            numStrTmp = String.valueOf(numIntImp);
            numStr = numStr + numStrTmp;
            numArray[i] = numIntImp;
        }
    }
    private int randomColor(){
        colorArray[0]=0xFF000000; //BLACK
        colorArray[1] = 0xFFFF00FF; // MAGENTA
        colorArray[2] = 0xFFFF0000; // RED
        colorArray[3] = 0xFF00FF00; // GREEN
        colorArray[4] = 0xFF0000FF; // BLUE
        colorArray[5] = 0xFF00FFFF; // CYAN
        int randomColoId=new Random().nextInt(5);
        return colorArray[randomColoId];
    }
    private int randomAngle(){
        return 20*(new Random().nextInt(5)-new Random().nextInt(3));
    }
    private class OnClickListenerImpl implements View.OnClickListener {
        @Override
        public void onClick(View v) {
            if (v == btLogin) {
                if (TextUtils.isEmpty(userEditText.getText().toString())) {
                    userEditText.setShakeAnimation();
                    Toast.makeText(MainActivity.this, "账户或密码不能为空", Toast.LENGTH_SHORT)
                            .show();
                }
                if (TextUtils.isEmpty(psdEditText.getText().toString())) {
                    //为空时抖动提示
                    psdEditText.setShakeAnimation();
                    Toast.makeText(MainActivity.this, "账户或密码不能为空", Toast.LENGTH_SHORT)
                            .show();
                }
                if (etCheck.getText().toString() != null &&
                        etCheck.getText().toString().trim().length() > 0) {
                    tvCheck.setVisibility(View.VISIBLE);
                    if (numStr.equals(etCheck.getText().toString())) {
                        tvCheck.setTextColor(Color.GREEN);
                        tvCheck.setText("验证码正确！");
                    } else {
                        tvCheck.setTextColor(Color.RED);
                        tvCheck.setText("验证码错误！");
                        etCheck.setText("");
                        setNum();
                    }
                }
            } else {
                setNum();
                tvCheck.setVisibility(View.GONE);
            }
        }
    }
}
```